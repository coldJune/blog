---
title: 绘图和可视化
date: 2018-03-23 10:57:04
categories: 数据分析
copyright: true
tags:
    - 可视化
    - 数据分析
description: 绘图是数据分析工作中的最重要的任务之一，是探索过程的一部分
---
## matplotlib API入门
使用[matplotlib](https://matplotlib.org/index.html)时以`--pylab`模式打开
```
ipython --pylab
```
matplotlib API的函数都位于matplotlib.pyplot模块之下，通常通过以下语句引用:
```
import matplotlib.pyplot as plt
```
### Figure和Subplot
matplotlib的图像都位于Figure对象中，使用`plt.figure`创建一个新的Figure；`plt.figure`的`figsize`选项用于确保当图片保存到磁盘时具有一定的大小和纵横比；通过`plt.gcf()`等到当前Figure的引用；不能再空Figure上绘图，必须通过`add_subplot`创建一个或多个subplot，返回的对象是AxesSubplot对象：
```
In [7]: fig = plt.figure()

In [8]: ax1 = fig.add_subplot(2,2,1)  #在figure实例上调用add_subplot创建一个2x2的图像，且当前选中的事第一个(编号从1
   ...: 开始)

In [9]: ax2 = fig.add_subplot(2,2,2)

In [10]: ax3 = fig.add_subplot(2,2,4)

```
* 带有三个subplot的Figure
![带有三个subplot的Figure](绘图和可视化/Figure_1.png)
如果这时发出一条绘图命令，matplotlib会在最后一个用过的subplot(没有则创建一个)上进行绘制,`k--`是一个线型选项，告诉matplotlib绘制黑色虚线图:
```
In [16]: plt.plot(randn(50).cumsum(),'k--')
Out[16]: [<matplotlib.lines.Line2D at 0x26fc86694a8>]

In [17]: plt.savefig('Figure_2.png')
```
* 绘制一次后的图像
![绘制一次后的图像](绘图和可视化/Figure_2.png)
对于`add_subplot`返回AxesSubplot直接调用它们的实例方法就可以在对应的实例上画图了：
```
In [14]: _ = ax1.hist(randn(100),bins=20,color='k',alpha=0.3)

In [15]: ax2.scatter(np.arange(30),np.arange(30)+3*randn(30))
Out[15]: <matplotlib.collections.PathCollection at 0x2213001c2e8>

In [16]: plt.savefig('Figure_3.png')
```
* 继续绘制两次之后的图像
![继续绘制两次之后的图像](绘图和可视化/Figure_3.png)

`plt.subplots`创建一个新的Figure，返回一个含有已创建的subplot对象的NumPy数组，可以通过索引获取对应的AxesSubplot对象进行绘图:
* pyplot.subplots的选项

|    参数    |                             说明                              |
|:----------:|:-------------------------------------------------------------:|
|   nrows    |                         subplot的行数                         |
|   ncols    |                         subplot的列数                         |
|   sharex   | 所有subplot应该使用相同的X轴刻度(调节xlim将会影响所有subplot) |
|   sharey   | 所有subplot应该使用相同的Y轴刻度(调节ylim将会影响所有subplot) |
| subplot_kw |                 用于创建个subplot的关键字字典                 |
|  **fig_kw  |    创建figure的其他关键字如plt.subplots(2,2,figsize=(8,6))    |

```
In [17]: fig,axes = plt.subplots(2,3)

In [18]: axes
Out[18]:
array([[<matplotlib.axes._subplots.AxesSubplot object at 0x000002213099BDD8>,
        <matplotlib.axes._subplots.AxesSubplot object at 0x000002213088D940>,
        <matplotlib.axes._subplots.AxesSubplot object at 0x0000022136CD45F8>],
       [<matplotlib.axes._subplots.AxesSubplot object at 0x0000022136CE7358>,
        <matplotlib.axes._subplots.AxesSubplot object at 0x0000022136B9E320>,
        <matplotlib.axes._subplots.AxesSubplot object at 0x0000022136BBB198>]], dtype=object)

In [19]: fig
Out[19]: <matplotlib.figure.Figure at 0x22130a437b8>

In [20]: axes[0,1].scatter(np.arange(30),np.arange(30)+3*randn(30))
Out[20]: <matplotlib.collections.PathCollection at 0x22136ead278>

In [21]: fig.savefig('Figure_4.png')
```
* 通过`plt.subplots`创建的Figure和AxesSubplot数组
![通过`plt.subplots`创建的Figure和AxesSubplot数组](绘图和可视化/Figure_4.png)

#### 调整subplot周围的间距
matplotlib会在subplot外围留下一定的边距，并在subplot之间留下一定的间距。间距和图像的高宽有关，只要图像大小调整则间距也会自动调整利用的Figure的`subplots_adjust`方法可以修改间距，同时它也是个顶级函数；`wspace`和`hspace`用于控制宽度和高度的百分比，可以用作subplot之间的间距。matplotlib不会检查标签是否重叠，所以只能自己设定刻度的位置和刻度标签:
```
In [23]: plt.subplots_adjust(wspace=0,hspace=0)

In [24]: fig.savefig('Figure_5.png')
```
* 调整间距之后的图像
![调整间距之后的图像](绘图和可视化/Figure_5.png)

#### 颜色、标记和线型
matplotlib的plot函数接受一组X和Y的坐标，还可以接受一个表示`color`颜色和`linestyle`[线型](https://matplotlib.org/api/_as_gen/matplotlib.lines.Line2D.html?highlight=drawstyle#matplotlib.lines.Line2D.lineStyles)的字符串缩写；常用的颜色都有一个缩写词(`color='g'`)，如果需要使用其他颜色可以指定其RGB值('#CECECE')；线形图可以加上一些[标记](https://matplotlib.org/api/_as_gen/matplotlib.lines.Line2D.html?highlight=drawstyle#matplotlib.lines.Line2D.markers)`marker`来强调实际的数据点；标记和颜色都可以放在格式字符串中，但标记类型和线型必须放在颜色后面：
```
In [29]: fig = plt.figure()

In [30]: axe1 = fig.add_subplot()

In [31]: plt.plot(data,'ko--')
Out[31]: [<matplotlib.lines.Line2D at 0x22137639198>]

In [32]: plt.plot(data,color='k',linestyle='dashed',marker='o')
Out[32]: [<matplotlib.lines.Line2D at 0x2213a7bd588>]

In [33]: plt.savefig('Figure_6.png')
```
* 带有标记的线型图实例
![带有标记的线形图实例](绘图和可视化/Figure_6.png)
非实际数据点默认是按线性方式插值的，可以通过[drawstyle选项](https://matplotlib.org/api/_as_gen/matplotlib.lines.Line2D.html?highlight=drawstyle#matplotlib.lines.Line2D.drawStyles)修改:
```
In [34]: plt.plot(data,'k--',label='Default')
Out[34]: [<matplotlib.lines.Line2D at 0x22134d35198>]

In [35]: plt.plot(data,'k--',label='step-post',drawstyle='steps-post')
Out[35]: [<matplotlib.lines.Line2D at 0x22134d35b70>]

In [37]: plt.legend(loc='best')
Out[37]: <matplotlib.legend.Legend at 0x22134b3a240>
```
* 使用不同的drawstyle选项的线型图实例
![修改之后的线型图实例](绘图和可视化/Figure_7.png)

#### 刻度、标签和图例
对于大多数图标的装饰项，有两种实现方式，一是使用过程型的pyplot接口，而是使用面向对象的原生matplotlib API。pyplot接口是为了交互式使用，它含有`xlim`、`xticks`和`xticklabels`等方法。分别控制图标的范围、刻度位置、刻度标签等。使用方式有两种：
1. 调用时不带参数，则返回当前的配置值。(`plt.xlim()`返回当前的X轴绘图范围)
2. 调用时带参数，则是则会参数值。(`plt.xlim([0,10])`将X轴的范围设置为0到10)
所有方法都是对当前或最近创建的AxesSubplot起作用的，它们各自对应subplot对象的两个方法，以`xlim`为例对应`ax.get_xlim`和`ax.set_xlim`

##### 设置标题、轴标签、刻度以及刻度标签
要修改X轴的刻度，使用`set_xticks`和`set_xticklabels`方法。`set_xticks`告诉matplotlib要将刻度放在数据范围中的哪些位置，默认情况下这些位置也就是刻度标签。`set_xticklabels`将任何其他值用作标签；`set_xlabel`为X轴设置一个名称;`set_title`设置一个标题：
```
In [39]: fig = plt.figure()

In [40]: ax = fig.add_subplot(1,1,1)

In [41]: ax.plot(randn(1000).cumsum())
Out[41]: [<matplotlib.lines.Line2D at 0x2213dfb8e48>]

In [42]: fig.savefig('Figure_8.png')

In [43]: ticks = ax.set_xticks([0,250,500,700,1000])

In [44]: fig.savefig('Figure_9.png')

In [45]: labels = ax.set_xticklabels(['one','two','three','four','five'], rotation=30, fontsize='small')

In [46]: ax.set_title('FIRST')
Out[46]: <matplotlib.text.Text at 0x2213f03bb70>

In [47]: ax.set_xlabel('STAGES')
Out[47]: <matplotlib.text.Text at 0x2213ddaf320>

In [48]: fig.savefig('Figure_10.png')
```
* 用于显示xticks的线型图
![](绘图和可视化/Figure_8.png)![](绘图和可视化/Figure_9.png)![](绘图和可视化/Figure_10.png)
##### 添加图例
图例(legend)是一种标识图标元素的重要工具，通过在天剑subplot的时候传入`label`参数，然后调用`ax.legend(loc='best')`；其中`legend`的`loc`参数告诉matplotlib要将图例放在哪儿。要从图例中去除一个或多个元素，不传入label或传入`label='_nolegend_'`:
```
In [51]: fig = plt.figure()

In [52]: ax = fig.add_subplot(1,1,1)

In [53]: ax.plot(randn(1000).cumsum(),'k',label='one')
Out[53]: [<matplotlib.lines.Line2D at 0x22136e7f5c0>]

In [54]: ax.plot(randn(1000).cumsum(),'k--',label='two')
Out[54]: [<matplotlib.lines.Line2D at 0x221404f6be0>]

In [55]: ax.plot(randn(1000).cumsum(),'k.',label='three')
Out[55]: [<matplotlib.lines.Line2D at 0x2213b9aba58>]

In [56]: ax.legend(loc='best')
Out[56]: <matplotlib.legend.Legend at 0x2213dffc208>

In [57]: fig.savefig('Figure_11.png')
```
* 带有三条线及图例的简单线型图
![带有三条线及图例的简单线型图](绘图和可视化/Figure_11.png)

### 注解以及在Subplot上绘图
#### 注解
注解可以通过`text`、`arrow`和`annotate`等函数添加。`text`可以将文本绘制在图标的指定坐标(x,y)，还可以加上一些自定义格式`ax.text(x,y,'Hello world!', family='monospace', fontsize=10)`，注解中可以既含有文本也哈有箭头：
```
In [67]: fig = plt.figure()

In [68]: ax = fig.add_subplot(1,1,1)

In [69]: data = pd.read_csv('D:\Python\ipython\spx.csv',index_col=0, parse_dates=True)

In [70]: spx = data['SPX']

In [71]: spx.plot(ax=ax, style='k-')
Out[71]: <matplotlib.axes._subplots.AxesSubplot at 0x2213f993c50>

In [72]: crisis_data = [
    ...:         (datetime(2007,10,11),'Peak of bull market'),
    ...:         (datetime(2008,3,12),'Bear Stearbs Fails'),
    ...:         (datetime(2008,9,15),'Lehman Bankruptcy')
    ...:         ]
    ...:

In [73]: for date, label in crisis_data:
    ...:     ax.annotate(label, xy=(date,spx.asof(date)+50),
    ...:                 xytext=(date, spx.asof(date)+200),
    ...:                 arrowprops=dict(facecolor='black'),
    ...:                 horizontalalignment='left', verticalalignment='top')
    ...:

In [74]: # 放大到2007-2010

In [76]: ax.set_xlim(['1/1/2007','1/1/2011'])
Out[76]: (732677.0, 734138.0)

In [76]: ax.set_xlim(['1/1/2007','1/1/2011'])
Out[76]: (732677.0, 734138.0)
```
* 2008-2009年金融危机期间的重要日期[^1]
![2008-2009年金融危机期间的重要日期](绘图和可视化/Figure_12.png)

#### 绘图
matplotlib有一些表示常见图形的对象被称为快(patch)，完整的集合位于matplotlib.patches中，有些可以在matplotlib.pyplot中找到(如Rectangle和Circle)。要在图表中添加一个图形，需要先创建一个块对象shp，然后通过`ax.add_patch(shp)`将其添加到subplot中:
```
In [81]: fig = plt.figure()

In [82]: ax = fig.add_subplot(1,1,1)

In [83]: rect = plt.Rectangle((0.2,0.75),0.4,0.15,color='k',alpha=0.3)

In [84]: circ = plt.Circle((0.7,0.2),0.15,color='b',alpha=0.3)

In [85]: pgon = plt.Polygon([[0.15,0.15],[0.35,0.4],[0.2,0.6]],color='g',alpha=0.5)

In [86]: ax.add_patch(rect)
Out[86]: <matplotlib.patches.Rectangle at 0x22142e4a908>

In [87]: ax.add_patch(circ)
Out[87]: <matplotlib.patches.Circle at 0x22140caa6d8>

In [88]: ax.add_patch(pgon)
Out[88]: <matplotlib.patches.Polygon at 0x2214117b940>

In [89]: fig.savefig('Figure_13.png')
```
* 由三块图形组成的图
![由三块图形组成的图](绘图和可视化/Figure_13.png)

### 将图表保存到文件
利用`plt.savefig`可以将当前图表保存到文件，其相当于Figure对象的实例方法`savefig`。文件类型是通过文件扩展名推断出来的。可以通过`dpi`参数控制分辨率，通过`bbox_inches`剪除当前图表周围的空白部分`plt.savefig('filepath.png', dpi=400,bbox_inches='tight')`;
* savepig的选项

|         参数         |                                  说明                                  |
|:--------------------:|:----------------------------------------------------------------------:|
|        fname         | 含有文件路径的字符串或Python的文件型对象。图像格式由文件扩展名推断得出 |
|         dpi          |                    图像分辨率(每英寸点数),默认为100                    |
| facecolor、edgecolor |                     图像的背景色，默认为"w"(白色)                      |
|        format        |                  显式设置文件格式(png/pdf/svg/ps....)                  |
|     bbox_inches      |   图表需要保存的部分。如果设置为"tight"则尝试剪除图表周围的空白部分    |

### matplotlib配置
matplotlib自带一些配色方案，几乎所有默认行为都能通过一组全局参数进行自定义，它们可以管理图像大小、subplot边距、配色方案、字体大小、网格类型等。操作matplotlib配置系统可以使用`rc`方法，`rc`第一个参数是希望自定义的对象，其后可以跟上一系列的关键字参数，可以将这些选项写成一个字典:
```
In [100]: font_options={'family':'monospace',
     ...:               'weight':'bold',
     ...:               'size':10}
     ...:

In [101]: plt.rc('font', **font_options)
```
[^1]:[数据来源](https://github.com/coldJune/Python/blob/master/ipython/spx.csv)
