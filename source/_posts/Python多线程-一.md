---
title: Python多线程(一)
date: 2018-02-24 16:13:37
categories: Python
copyright: true
tags:
    - Python
    - 多线程
description:
---
多线程编程对于以下编程任务是非常理想的：
* 本质上是异步的
* 需要多个并发活动
* 每个活动的处理顺序可能是不确定的(随机、不可预测的)
<!--Mare-->
使用多线程或者类似Queue的共享数据结构可以将一个串行程序规划成几个执行特定任务的线程
* UserRequestThread: 负责读取客户端输入。程序将创建多个线程，每个客户端一个，客户端的请求将会被放入队列中
* RequestProcessor: 该线程负责从队列中获取请求并进行处理，为第三个线程提供输出
* ReplyThread: 负责向用户输出，将结果传回给用户，或者把数据写到本地文件系统或者数据库中

## 线程和进程

* 进程
  > 计算机程序是储存在磁盘上的可执行二进制(或其他类型)的文件。**进程** （有时称为 **重量级进程**）则是一个执行中的程序。
    每一个进程都拥有自己的地址空间、内存、数据栈以及其他用于跟踪执行的辅助数据。操作系统管理其上的所有进程的执行，并为它们合理地分配时间。
  进程可以通过 **派生**(fork或spawn)新的进程来执行任务,而进程之间的通信只能通过 *进程间通信(IPC)* 的方式共享信息

* 线程
  > **线程**（有时称为 **轻量级进程**）共享相同的上下文。相当于在主进程中并行运行的一些“迷你进程”。当其他线程运行是，它可以被抢占（中断）
    和临时挂起（睡眠），这种做法叫 *让步(yielding)*。早单核CPU系统中，线程的实际规划是：每个线程运行一小会儿，然后让步给其他线程（再次排队
    等待更多的CPU时间）。在整个进程的执行当中，每个线程执行它自己特定的任务，在必要时和其他线程进行结果通信。

## 线程与Python

### 全局解释锁
  对Python虚拟机的访问是由 **全局解释锁(GIL)** 控制的。这个锁用来保证同时只能有一个线程运行。在多线程环境中，Python虚拟机将按照下面的方式执行。
  1. 设置GIL
  2. 切换进一个线程去运行
  3. 执行下面操作之一
      a. 指定数量的字节码指令
      b. 线程主动让出控制权(可以调用time.sleep(0)来完成)
  4. 把线程设置回睡眠状态(切换出线程)
  5. 解锁GIL
  6. 重复上述步骤
  当调用外部代码(即，任意C/C++扩展的内置函数)时，GIL会保持锁定，直至函数执行结束。

### 退出线程
  当一个线程完成函数的执行时，就会退出。还可以通过调用`thread.exit()`或者`sys.exit()`退出进程，或者抛出SystemExit异常，是线程退出。
