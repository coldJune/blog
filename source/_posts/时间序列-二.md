---
title: 时间序列(二)
date: 2018-03-28 09:38:54
categories: 数据分析
copyright: true
tags:
    - 时间序列
    - 数据分析
description: 无论在什么领域中，时间序列(time series)数据是一种重要的结构化数据
---
## 时期及其算术运算
**时期(period)** 表示的事时间时区，比如数日、数月、数季、数年等。Period类的构造函数需要用到一个字符串或整数，以及[频率](http://coldjune.com/2018/03/27/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97-%E4%B8%80/#%E9%A2%91%E7%8E%87%E5%92%8C%E6%97%A5%E6%9C%9F%E5%81%8F%E7%A7%BB%E9%87%8F)；对Period对象加上或减去一个整数可根据其频率进行位移；如果两个Period对象拥有相同的频率，则它们的差就是它们之间的单位数量；`period_range`函数可用于创建规则的时期范围；PeriodIndex类保存了一组Period，可以在任何pandas数据结构中被用作轴索引，其构造函数还允许直接使用一组字符串:
```Python
In [3]: # 构造一个Period

In [4]: p = pd.Period(2018, freq='A-DEC')

In [5]: p
Out[5]: Period('2018', 'A-DEC')

In [6]: # 构造一个Period

In [7]: p = pd.Period(2018, freq='A-DEC')

In [8]: p #表示2018年1月1日到2018年12月31日之间的整段时间
Out[8]: Period('2018', 'A-DEC')

In [9]: # 通过加减整数进行位移

In [10]: p+5
Out[10]: Period('2023', 'A-DEC')

In [11]: p-5
Out[11]: Period('2013', 'A-DEC')

In [12]: # 两个相同频率的Period对象的差值

In [13]: pd.Period('2021', freq='A-DEC')-p
Out[13]: 3

In [14]: # 使用period_range创建时期范围

In [20]: g = pd.period_range('2017-8-4','3/28/2018', freq='M')

In [21]: g
Out[21]:
PeriodIndex(['2017-08', '2017-09', '2017-10', '2017-11', '2017-12', '2018-01',
             '2018-02', '2018-03'],
            dtype='period[M]', freq='M')

In [23]: #将PeriodIndex用作轴索引

In [24]: Series(np.random.randn(len(g)),index=g)
Out[24]:
2017-08   -0.373261
2017-09   -0.477122
2017-10   -0.791722
2017-11   -0.270160
2017-12   -0.487488
2018-01   -0.794482
2018-02   -0.859940
2018-03   -2.178295
Freq: M, dtype: float64

In [28]: #直接使用一组字符串构造PeriodIndex

In [29]: values = ['2018Q1','2019Q4','2020Q3']

In [30]: index = pd.PeriodIndex(values, freq='Q-DEC')

In [31]: index
Out[31]: PeriodIndex(['2018Q1', '2019Q4', '2020Q3'], dtype='period[Q-DEC]', freq='Q-DEC')

```
### 时期的频率转换
Period和PeriodIndex对象可以通过`asfreq`方法转换成别的频率，在将高频率装换为低频率时，超时期(superperiod)是由子时期(subperiod)所属的位置决定的(*在A-JUN频率中，月份“2018年8月”实际上是属于周期“2019年”*):
```Python
In [35]: p = pd.Period('2018', freq='A-DEC') # 构造一个年度时期

In [36]: # 转换为年初或年末的一个月度时期

In [37]: p.asfreq('M', how='start') #月初
Out[37]: Period('2018-01', 'M')

In [38]: p.asfreq('M', how='end') #月末
Out[38]: Period('2018-12', 'M')

In [43]: #不以12月结束的财政年度，月度时期的归属情况不一样

In [44]: p = pd.Period('2018',freq='A-JUN')

In [45]: p.asfreq('M',how='start')
Out[45]: Period('2017-07', 'M')

In [46]: p.asfreq('D',how='end')
Out[46]: Period('2018-06-30', 'D')

In [47]: # 高频率转换成低频率

In [48]: p = pd.Period('2017-8','M')

In [49]: p.asfreq('A-JUN')
Out[49]: Period('2018', 'A-JUN')

In [50]: #PeriodIndex或TimeSeries的频率转换方式

In [51]: rng = pd.period_range('2017','2020', freq='A-DEC')

In [52]: ts = Series(np.random.randn(len(rng)), index=rng)

In [53]: ts
Out[53]:
2017    0.217544
2018    1.215839
2019    0.985624
2020    1.705840
Freq: A-DEC, dtype: float64

In [54]: ts.asfreq('M', how='start')
Out[54]:
2017-01    0.217544
2018-01    1.215839
2019-01    0.985624
2020-01    1.705840
Freq: M, dtype: float64

In [55]: ts.asfreq('B', how='end')
Out[55]:
2017-12-29    0.217544
2018-12-31    1.215839
2019-12-31    0.985624
2020-12-31    1.705840
Freq: B, dtype: float64
```
* Period频率转换示例
![Period频率转换示例](时间序列-二/Period频率转换示例.png)

### 按季度计算的时期频率
季度型数据在会计、金融等领域中很常见。许多季度型数据都会涉及"财年末"的概念，通常是一年12个月中某月的最后一个日历日或工作日。时期"2018Q4"根据财年末的不同会有不同的含义，pandas支持12种可能的季度型频率即`Q-JAn`到`Q-DEC`。例如在以1月结束的财年中，2018Q4是从11月到1月；`period_range`还可用于生成季度型范围
```Python
In [56]: #创建以1月结束的财年

In [57]: p = pd.Period('2018Q4', freq='Q-JAN')

In [58]: p
Out[58]: Period('2018Q4', 'Q-JAN')

In [59]: p.asfreq('D','start')
Out[59]: Period('2017-11-01', 'D')

In [60]: p.asfreq('D','e')
Out[60]: Period('2018-01-31', 'D')

In [67]: #该季度倒数第二个工作日下午4点的时间戳

In [68]: p4pm = (p.asfreq('B', 'e')-1).asfreq('T','s')+16*60

In [69]: p4pm
Out[69]: Period('2018-01-30 16:00', 'T')

In [70]: p4pm.to_timestamp()
Out[70]: Timestamp('2018-01-30 16:00:00')

In [71]: # period_range还可用于生成季度型范围

InIn [72]: rng = pd.period_range('2017Q1','2018Q4', freq='Q-JAN')

In [73]: ts = Series(np.random.randn(len(rng)), index=rng)

In [74]: ts
Out[74]:
2017Q1    0.763694
2017Q2   -0.192030
2017Q3   -0.514838
2017Q4    0.071501
2018Q1   -0.765586
2018Q2    0.695312
2018Q3    0.747142
2018Q4   -0.359449
Freq: Q-JAN, dtype: float64

In [75]: # 季度型范围的算术运算

In [76]: new_rng = (rng.asfreq('B','e')-1).asfreq('T','s')+16*60

In [77]: ts.index = new_rng.to_timestamp()

In [78]: ts
Out[78]:
2016-04-28 16:00:00    0.763694
2016-07-28 16:00:00   -0.192030
2016-10-28 16:00:00   -0.514838
2017-01-30 16:00:00    0.071501
2017-04-27 16:00:00   -0.765586
2017-07-28 16:00:00    0.695312
2017-10-30 16:00:00    0.747142
2018-01-30 16:00:00   -0.359449
dtype: float64

```
### 将Timestamp转换为Period(及其反向过程)
通过使用`to_period`方法，可以将由时间戳索引的Series或DataFrame对象转换成以时期索引，由于时期指的是 **非重叠时间区间** ，因此对于给定的频率，一个时间戳只能属于一个时期。新PeriodIndex的频率默认是从时间戳推断出来的，也可以指定任何其他频率，结果中允许存在重复时期。要转换为时间戳可以使用`to_timestamp`方法:
```Python
In [84]: # 将时间戳转换为时期

In [85]: ts = Series(np.random.randn(len(rng)), index=rng)

In [86]: # 将时间戳转换为时期

In [87]: rng = pd.date_range('3/29/2018 8:51', periods=3, freq='M')

In [88]: ts = Series(np.random.randn(len(rng)), index=rng)

In [89]: pts = ts.to_period()

In [90]: ts
Out[90]:
2018-03-31 08:51:00    0.473123
2018-04-30 08:51:00   -0.278769
2018-05-31 08:51:00    0.903042
Freq: M, dtype: float64

In [91]: pts
Out[91]:
2018-03    0.473123
2018-04   -0.278769
2018-05    0.903042
Freq: M, dtype: float64

In [92]: #指定频率转换，允许存在重复时期

In [93]: rng = pd.date_range('3/29/2018 8:51', periods=5, freq='D')

In [94]: ts2 = Series(np.random.randn(len(rng)), index=rng)

In [95]: ts2.to_period('M')
Out[95]:
2018-03   -0.579708
2018-03    0.793771
2018-03    0.327913
2018-04    0.248145
2018-04    1.324320
Freq: M, dtype: float64

In [96]: # 使用to_timestamp转换为时间戳

In [97]: pts
Out[97]:
2018-03    0.473123
2018-04   -0.278769
2018-05    0.903042
Freq: M, dtype: float64

In [98]: pts.to_timestamp(how='end')
Out[98]:
2018-03-31    0.473123
2018-04-30   -0.278769
2018-05-31    0.903042
Freq: M, dtype: float64
```

### 通过数组创建PeriodIndex
固定频率的数据集通常会将时间信息分开存放在多个列中，下面的[宏观经济数据集]()中，年度和季度就分别放在不同的列中:
```Python
In [112]: data = pd.read_csv('macrodata.csv')

In [113]: data.year
Out[113]:
0      1959.0
1      1959.0
2      1959.0
        ...
202    2009.0
Name: year, Length: 203, dtype: float64

In [114]: data.quarter
Out[114]:
0      1.0
1      2.0
2      3.0
3      4.0
4      1.0
5      2.0
      ...
202    3.0
Name: quarter, Length: 203, dtype: float64

In [115]: #将两个数组以及一个频率传入PeriodIndex，将它们合并成DataFrame的一个索引

In [116]: index = pd.PeriodIndex(year=data.year,quarter=data.quarter,freq='Q-DEC')

In [117]: index
Out[117]:
PeriodIndex(['1959Q1', '1959Q2', '1959Q3', '1959Q4', '1960Q1', '1960Q2',
             '1960Q3', '1960Q4', '1961Q1', '1961Q2',
             ...
             '2007Q2', '2007Q3', '2007Q4', '2008Q1', '2008Q2', '2008Q3',
             '2008Q4', '2009Q1', '2009Q2', '2009Q3'],
            dtype='period[Q-DEC]', length=203, freq='Q-DEC')

In [118]: data.index=index

In [119]: data.infl
Out[119]:
1959Q1    0.00
1959Q2    2.34
1959Q3    2.74
          ...
2009Q1    0.94
2009Q2    3.37
2009Q3    3.56
Freq: Q-DEC, Name: infl, Length: 203, dtype: float64
```
