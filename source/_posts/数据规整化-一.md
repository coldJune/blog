---
title: 数据规整化(一)
date: 2018-03-21 19:30:39
categories: 数据分析
copyright: true
tags:
    - 数据清洗
    - 数据分析
description: 数据分析和建模方面的大量编程工作都是在做数据准备:加载、清理、转换以及重塑。
---
## 合并数据集
pandas对象中的数据可以通过内置的方式进行合并:
* `pandas.merge`可根据一个或多个键讲不通DataFrame中的行连接起来(数据库连接操作)[^1]
* `pandas.concat`可以沿着一条轴将多个对象堆叠到一起
* 实例方法`combine_first`可以将重复数据编接在一起，用一个对象中的值填充另一个对象的中的缺失值(先从第一个对象选值，不行就去第二个对象中选值)

* merge函数的参数
|    参数     |                                                             说明                                                             |
|:-----------:|:----------------------------------------------------------------------------------------------------------------------------:|
|    left     |                                                   参数合并的左侧DataFrame                                                    |
|    right    |                                                   参与合并的右侧DataFrame                                                    |
|     how     |                                       "inner"、"outer"、"left"、"right"。默认为"inner"                                       |
|     on      |   用于连接的列名。必须存在于左右两个DataFrame对象中。如果未指定，且其他连接键也未指定，则以left和right列名的交集作为连接键   |
|   left_on   |                                                左侧DataFrame中用作连接键的列                                                 |
|  right_on   |                                                右侧DataFrame中用作连接键的列                                                 |
| left_index  |                                                  将左侧的行索引用作其连接键                                                  |
| right_index |                                                  将右侧的行索引用作其连接键                                                  |
|    sort     |                       根据连接键合并后的数据进行排序，默认为True。处理大数据集时，禁用会获得更好的性能                       |
|  suffixes   | 字符串值元组，用于追加到重叠列名的末尾，默认为('_x','_y')。(如果左右两个DataFrame中都有data，则结果会出现"data_x"和"data_y") |
|    copy     |                        设置为False，可以在某些特殊情况下避免将数据复制到结果数据结构中。默认总是复制                         |

### 数据库风格的DataFrame合并
数据集的合并(merge)或链接(join)运算是通过一个或多个键将行链接起来。

#### 多对一
df1中的数据key列中有多个被标记为a,b的行，而df2中key列的每个值仅对应一行。如果没有指定要用哪个列进行链接，`merge`就会将重叠列的列名当做键，最好通过`on`显式指定；如果两个列的列名不同可以分别使用`left_on`和`right_on`指定；默认情况下`merge`做的是`inner`链接，即结果是键的交集，所以c的数据被剔除了；外链接`outer`求的是并集，结合了左链接`left`和右链接`right`的效果，通过`how`来指定链接方式:
```
In [14]: df1 = DataFrame({'key':list('aaccbbc'),
    ...:                  'data1':range(7)})
    ...:

In [15]: df2 = DataFrame({'key':list('abc'),
    ...:                  'data2':range(3)})
    ...:

In [16]: df1
Out[16]:
   data1 key
0      0   a
1      1   a
2      2   c
3      3   c
4      4   b
5      5   b
6      6   c

In [17]: df2
Out[17]:
   data2 key
0      0   a
1      1   b
2      2   c

In [18]: pd.merge(df1,df2)
Out[18]:
   data1 key  data2
0      0   a      0
1      1   a      0
2      2   c      2
3      3   c      2
4      6   c      2
5      4   b      1
6      5   b      1

In [19]: df1.merge(df2,on='key')
Out[19]:
   data1 key  data2
0      0   a      0
1      1   a      0
2      2   c      2
3      3   c      2
4      6   c      2
5      4   b      1
6      5   b      1

In [20]: df3 = DataFrame({'lkey':list('aaccbbc'),
    ...:                  'data1':range(7)})
    ...:

In [21]: df4 = DataFrame({'rkey':list('abc'),
    ...:                  'data2':range(3)})
    ...:

In [22]: pd.merge(df3,df4,left_on='lkey',right_on='rkey')
Out[22]:
   data1 lkey  data2 rkey
0      0    a      0    a
1      1    a      0    a
2      2    c      2    c
3      3    c      2    c
4      6    c      2    c
5      4    b      1    b
6      5    b      1    b

In [23]: df1.merge(df2,on='key',how='outer')
Out[23]:
   data1 key  data2
0      0   a      0
1      1   a      0
2      2   c      2
3      3   c      2
4      6   c      2
5      4   b      1
6      5   b      1
```

#### 多对多
多对多链接产生的是行的笛卡尔积，链接方式只影响出现在结果中的键；要根据多个键进行合并，传入一个由列名组成的列表即可(可以看成组合外键)；对于列名重复的问题可以通过设置`suffixes`选项指定附加到左右两个DataFrame对象列名上的字符串：
```
In [29]: df1 = DataFrame({'key':list('aaccbbc'),
    ...:                  'data1':range(7)})
    ...:

In [30]: df2 = DataFrame({'key':list('abacd'),
    ...:                  'data2':range(5)})
    ...:

In [31]: df1
Out[31]:
   data1 key
0      0   a
1      1   a
2      2   c
3      3   c
4      4   b
5      5   b
6      6   c

In [32]: df2
Out[32]:
   data2 key
0      0   a
1      1   b
2      2   a
3      3   c
4      4   d

In [33]: pd.merge(df1,df2,on='key',how='left')
Out[33]:
   data1 key  data2
0      0   a      0
1      0   a      2
2      1   a      0
3      1   a      2
4      2   c      3
5      3   c      3
6      4   b      1
7      5   b      1
8      6   c      3

In [42]: left = DataFrame({'key1':['foo','foo','bar'],
    ...:                   'key2':['one','two','one'],
    ...:                   'lval':range(3)})
    ...:

In [43]: right = DataFrame({'key1':['bar','foo','bar','bar'],
    ...:                   'key2':['one','two','one','two'],
    ...:                   'lval':range(4)})
    ...:

In [44]: left
Out[44]:
  key1 key2  lval
0  foo  one     0
1  foo  two     1
2  bar  one     2

In [45]: right
Out[45]:
  key1 key2  lval
0  bar  one     0
1  foo  two     1
2  bar  one     2
3  bar  two     3

In [46]: left.merge(right,on=['key1','key2'],how='outer')
Out[46]:
  key1 key2  lval_x  lval_y
0  foo  one     0.0     NaN
1  foo  two     1.0     1.0
2  bar  one     2.0     0.0
3  bar  one     2.0     2.0
4  bar  two     NaN     3.0

In [47]: left.merge(right,on='key1',how='outer')
Out[47]:
  key1 key2_x  lval_x key2_y  lval_y
0  foo    one       0    two       1
1  foo    two       1    two       1
2  bar    one       2    one       0
3  bar    one       2    one       2
4  bar    one       2    two       3

In [48]: left.merge(right,on='key1',how='outer',suffixes=['_left','_right'])
Out[48]:
  key1 key2_left  lval_left key2_right  lval_right
0  foo       one          0        two           1
1  foo       two          1        two           1
2  bar       one          2        one           0
3  bar       one          2        one           2
4  bar       one          2        two           3
```

### 索引上的合并
当DataFrame中的连接键位于其索引上可以通过传入`left_index=True`和`right_index=True`来说明索引应该被用作连接键
[^1]: 可用做实例方法df1.merge(df2),df1想当于left，df2相当于right
