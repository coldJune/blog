---
title: 数据规整化(二)
date: 2018-03-22 15:01:03
categories: 数据分析
copyright: true
tags:
    - 数据清洗
    - 数据分析
description: 上一章主要记录了合并数据集，这里讲介绍转换和重塑
---
## 重塑和轴向旋转
### 重塑层次化索引
层次化索引为DataFrame数据的重排提供了具有良好一致性的方式。主要功能包括：
1. stack:将数据的列"旋转"为行
2. unstack:将数据的行"旋转"为列

* stack
对于一个简单的DataFrame使用`stack`方法会得到一个Series，`stack`在运算的时候默认会滤除缺失值，指定`dropna=False`可以保留：
```
In [112]: data = DataFrame(np.arange(6).reshape((2,3)),
     ...:                  index=pd.Index(['row1','row2'],name='row'),
     ...:                  columns=pd.Index(['col1','col2','col3'],name='col'))
     ...:

In [113]: data
Out[113]:
col   col1  col2  col3
row
row1     0     1     2
row2     3     4     5

In [114]: resulst = data.stack()

In [115]: resulst
Out[115]:
row   col
row1  col1    0
      col2    1
      col3    2
row2  col1    3
      col2    4
      col3    5
dtype: int32

In [124]: s1 = Series(np.arange(4),index=list('abcd'))

In [125]: s2 = Series([4,5,6],index=list('cde'))

In [126]: data2 = pd.concat([s1,s2],keys=['one','two'])

In [127]: data2
Out[127]:
one  a    0
     b    1
     c    2
     d    3
two  c    4
     d    5
     e    6
dtype: int64

In [129]: data2.unstack()
Out[129]:
       a    b    c    d    e
one  0.0  1.0  2.0  3.0  NaN
two  NaN  NaN  4.0  5.0  6.0

In [130]: data2.unstack().stack()
Out[130]:
one  a    0.0
     b    1.0
     c    2.0
     d    3.0
two  c    4.0
     d    5.0
     e    6.0
dtype: float64

In [132]: data2.unstack().stack(dropna=False)
Out[132]:
one  a    0.0
     b    1.0
     c    2.0
     d    3.0
     e    NaN
two  a    NaN
     b    NaN
     c    4.0
     d    5.0
     e    6.0
dtype: float64
```
* unstack
`unstack`可以将`stack`方法得到的Series重排为一个DataFrame；默认情况下，`unstack`操作的是最内层。传入分层级别的编号或名称即可对其他级别进行`unstack`操作，如果不是所有级别值都能在各分组中找到的话会引入缺失值；在对DataFrame进行`unstack`操作时，作为旋转轴的级别将会成为结果中的最低级别:
```
In [140]: resulst
Out[140]:
row   col
row1  col1    0
      col2    1
      col3    2
row2  col1    3
      col2    4
      col3    5
dtype: int32

In [141]: resulst.unstack()
Out[141]:
col   col1  col2  col3
row
row1     0     1     2
row2     3     4     5

In [142]: resulst.unstack(0)
Out[142]:
row   row1  row2
col
col1     0     3
col2     1     4
col3     2     5

In [143]: resulst.unstack('row')
Out[143]:
row   row1  row2
col
col1     0     3
col2     1     4
col3     2     5

In [144]: data2
Out[144]:
one  a    0
     b    1
     c    2
     d    3
two  c    4
     d    5
     e    6
dtype: int64

In [145]: data2.unstack()
Out[145]:
       a    b    c    d    e
one  0.0  1.0  2.0  3.0  NaN
two  NaN  NaN  4.0  5.0  6.0

In [151]: df = DataFrame({'left':resulst,'right':resulst+5},
     ...:                 columns=pd.Index(['left','right'], name='side'))
     ...:

In [152]: df
Out[152]:
side       left  right
row  col
row1 col1     0      5
     col2     1      6
     col3     2      7
row2 col1     3      8
     col2     4      9
     col3     5     10

In [153]: df.unstack('col')
Out[153]:
side left           right
col  col1 col2 col3  col1 col2 col3
row
row1    0    1    2     5    6    7
row2    3    4    5     8    9   10

In [154]: df.unstack('col').stack('side')
Out[154]:
col         col1  col2  col3
row  side
row1 left      0     1     2
     right     5     6     7
row2 left      3     4     5
     right     8     9    10
```

### 将“长格式”旋转为“宽格式”
先预处理实验数据，首先加载数据，使用`PeriodIndex`生成新的索引，使用`Index`选取索引然后使用`reindex`方法根据新的列索引生成数据，然后修改数据的行索引为时间索引，最后生成需要的数据:
```
In [217]: periods = pd.PeriodIndex(year=data.year, quarter=data.quarter,name='date')

In [218]: colums = pd.Index(['realgdp','infl','unemp'],name='item')

In [219]: data = data.reindex(columns=colums)

In [220]: data.index = periods.to_timestamp('D','end')

In [221]: ldata = data.stack().reset_index().rename(columns={0:'value'})
```
`pivot`第一个参数节后行索引的列名，第二参数是列索引的列名，最后一个参数值用于填充DataFrame的数据列的列名，如果忽略最后一个参数得到的DataFrame就会带有层次化的列:
```
In [233]: ldata[:10]
Out[233]:
        date     item     value
0 1959-03-31  realgdp  2710.349
1 1959-03-31     infl     0.000
2 1959-03-31    unemp     5.800
3 1959-06-30  realgdp  2778.801
4 1959-06-30     infl     2.340
5 1959-06-30    unemp     5.100
6 1959-09-30  realgdp  2775.488
7 1959-09-30     infl     2.740
8 1959-09-30    unemp     5.300
9 1959-12-31  realgdp  2785.204

In [234]: pivoted = ldata.pivot('date','item','value')

In [235]: pivoted.head()
Out[235]:
item        infl   realgdp  unemp
date
1959-03-31  0.00  2710.349    5.8
1959-06-30  2.34  2778.801    5.1
1959-09-30  2.74  2775.488    5.3
1959-12-31  0.27  2785.204    5.6
1960-03-31  2.31  2847.699    5.2

In [236]: ldata['value2'] = np.random.randn(len(ldata))

In [237]: ldata[:10]
Out[237]:
        date     item     value    value2
0 1959-03-31  realgdp  2710.349  0.944599
1 1959-03-31     infl     0.000  0.244179
2 1959-03-31    unemp     5.800  0.055830
3 1959-06-30  realgdp  2778.801  1.182520
4 1959-06-30     infl     2.340  0.266359
5 1959-06-30    unemp     5.100 -0.881742
6 1959-09-30  realgdp  2775.488  0.007021
7 1959-09-30     infl     2.740 -1.171792
8 1959-09-30    unemp     5.300  0.007356
9 1959-12-31  realgdp  2785.204  0.631422

In [238]: pivoted = ldata.pivot('date','item')

In [239]: pivoted[:5]
Out[239]:
           value                    value2
item        infl   realgdp unemp      infl   realgdp     unemp
date
1959-03-31  0.00  2710.349   5.8  0.244179  0.944599  0.055830
1959-06-30  2.34  2778.801   5.1  0.266359  1.182520 -0.881742
1959-09-30  2.74  2775.488   5.3 -1.171792  0.007021  0.007356
1959-12-31  0.27  2785.204   5.6  0.136254  0.631422 -0.850516
1960-03-31  2.31  2847.699   5.2 -2.338798  0.897056  0.296124

In [240]: pivoted['value2'][:5]
Out[240]:
item            infl   realgdp     unemp
date
1959-03-31  0.244179  0.944599  0.055830
1959-06-30  0.266359  1.182520 -0.881742
1959-09-30 -1.171792  0.007021  0.007356
1959-12-31  0.136254  0.631422 -0.850516
1960-03-31 -2.338798  0.897056  0.296124
```
相当于使用`set_index`创建层次化索引，再用`unstack`重塑:
```IPython
In [243]: ldata.set_index(['date','item']).unstack('item')[:5]
Out[243]:
           value                    value2
item        infl   realgdp unemp      infl   realgdp     unemp
date
1959-03-31  0.00  2710.349   5.8  0.244179  0.944599  0.055830
1959-06-30  2.34  2778.801   5.1  0.266359  1.182520 -0.881742
1959-09-30  2.74  2775.488   5.3 -1.171792  0.007021  0.007356
1959-12-31  0.27  2785.204   5.6  0.136254  0.631422 -0.850516
1960-03-31  2.31  2847.699   5.2 -2.338798  0.897056  0.296124
```
## 数据转换
前面描述的均为数据重排，而另一类重要操作则是过滤、清理以及其他转换工作。
### 移除重复数据
